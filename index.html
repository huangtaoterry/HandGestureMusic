<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>Gesture Spotify Player â€” Robust</title>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<style>
  :root{--green:#1db954;--bg:#191414}
  body{
    margin:0; font-family: "Segoe UI", Roboto, sans-serif;
    height:100vh; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(135deg,var(--green),var(--bg));
    color:#fff;
  }
  .card{
    width:720px; background:rgba(0,0,0,0.6); border-radius:16px; padding:18px;
    box-shadow:0 10px 40px rgba(0,0,0,0.6); display:flex; gap:18px; align-items:center;
  }
  #canvas{ border-radius:10px; background:#000; width:480px; height:360px; }
  .controls{ flex:1; display:flex; flex-direction:column; gap:12px; }
  .title{ font-size:20px; font-weight:600; }
  .track{ font-size:14px; color:#ddd; }
  .gesture{ font-size:18px; font-weight:700; color:yellow; }
  .vol-bar{ width:100%; height:10px; background:rgba(255,255,255,0.12); border-radius:6px; overflow:hidden; }
  .vol-fill{ height:100%; width:50%; background:var(--green); transition:width 0.12s linear; }
  audio{ width:100%; margin-top:6px; background:transparent; }
  .hint{ font-size:12px; color:#ccc; }
  .small{ font-size:12px; color:#bbb; }
</style>
</head>
<body>
  <div class="card">
    <canvas id="canvas" width="480" height="360"></canvas>

    <div class="controls">
      <div class="title">ğŸ¶ æ‰‹åŠ¿éŸ³ä¹æ’­æ”¾å™¨</div>
      <div class="track" id="trackName">Track: -</div>
      <div class="gesture" id="gestureName">æ£€æµ‹ä¸­â€¦</div>

      <div>
        <div class="small">éŸ³é‡</div>
        <div class="vol-bar"><div id="volFill" class="vol-fill"></div></div>
      </div>

      <audio id="player" controls></audio>
      <div class="hint">æ‰‹åŠ¿ï¼šğŸ– æ’­æ”¾ / âœŠ æš‚åœ / ğŸ‘‰ ä¸‹ä¸€é¦– / ğŸ‘ˆ ä¸Šä¸€é¦– / ğŸ‘Œ éŸ³é‡+ /  ğŸ‘‡éŸ³é‡-</div>
    </div>
  </div>

<script>
/* ------------ é…ç½®ä¸èµ„æº ------------ */
const audioFiles = ["music1.mp3","music2.mp3","music3.mp3","music4.mp3","music5.mp3","music6.mp3" ,"music7.mp3","music8.mp3","music9.mp3","music10.mp3" ]; // æŒ‰éœ€æ›¿æ¢
let currentTrack = 0;

const player = document.getElementById('player');
player.src = audioFiles[currentTrack];
player.volume = 0.5;

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const volFill = document.getElementById('volFill');
const trackName = document.getElementById('trackName');
const gestureNameEl = document.getElementById('gestureName');

trackName.innerText = `Track: ${audioFiles[currentTrack]}`;

/* ------------ å¹³æ»‘ä¸é˜²æŠ–å‚æ•° ------------ */
const SMOOTH_ALPHA = 0.6;         // EMA å¹³æ»‘ç³»æ•° (0..1) - è¶Šå¤§å¹³æ»‘ç¨‹åº¦è¶Šä½
const STABLE_FRAMES = 6;         // è¿ç»­ N å¸§æ‰ç¡®è®¤æ‰‹åŠ¿
const COOLDOWN_MS = 900;         // è§¦å‘åå†·å´ ms
const DIST_NORMALIZE_REF = [5,9]; // ç”¨ finger_mcp(5) ä¸ wrist(0) è·ç¦»ä½œä¸ºå°ºåº¦å‚è€ƒæ—¶ä½¿ç”¨ï¼ˆindex mcp ä¸º 5ï¼‰
let lastTriggerAt = 0;
let lastStableGesture = null;
let stableCount = 0;

/* ä¸Šä¸€å¸§å¹³æ»‘å…³é”®ç‚¹ */
let smoothLandmarks = null;

/* ç”Ÿæˆ video å…ƒç´ ï¼ˆéšè—ï¼‰ + MediaPipe Hands åˆå§‹åŒ– */
const video = document.createElement('video'); video.style.display='none';
document.body.appendChild(video);

const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands:1,modelComplexity:1,minDetectionConfidence:0.7,minTrackingConfidence:0.7});
hands.onResults(onResults);

const camera = new Camera(video, { onFrame: async ()=>{ await hands.send({image: video}); }, width:640, height:480 });
camera.start();

/* ------------ å®ç”¨å‡½æ•° ------------ */
function calcDist(a,b){
  const dx = a.x - b.x, dy = a.y - b.y;
  return Math.sqrt(dx*dx + dy*dy);
}
function ema(prev, curr, alpha){
  if(!prev) return curr.map(p=>({x:p.x,y:p.y,z:p.z||0}));
  return curr.map((p,i)=>({
    x: alpha * p.x + (1-alpha)*prev[i].x,
    y: alpha * p.y + (1-alpha)*prev[i].y,
    z: alpha * (p.z||0) + (1-alpha)*(prev[i].z||0)
  }));
}
/* å½’ä¸€åŒ–è·ç¦»ï¼ˆæŒ‰æ‰‹æŒå¤§å°ï¼‰*/
function normalizedDist(a,b,landmarks){
  // å‚è€ƒå°ºåº¦ï¼š wrist(0) <-> middle_finger_mcp(9) æˆ– index_mcp(5)
  const ref = calcDist(landmarks[0], landmarks[9] || landmarks[5]);
  if(ref === 0) return calcDist(a,b);
  return calcDist(a,b) / ref;
}

/* åˆ¤å®šå„æ‰‹æŒ‡æ˜¯å¦ä¼¸ç›´ï¼ˆåŸºäº tip vs pip çºµå‘ä½ç½®ï¼‰*/
function fingerExtended(landmarks, tipIdx, pipIdx){
  // æ³¨æ„ï¼šç”»é¢ y å‘ä¸‹å¢å¤§ â†’ tip.y < pip.y è¡¨ç¤ºâ€œå‘ä¸Š/ä¼¸ç›´â€
  return landmarks[tipIdx].y < landmarks[pipIdx].y;
}

/* æ›´ç¨³çš„æ‰‹åŠ¿åˆ¤å®šï¼šè¿”å›å­—ç¬¦ä¸²æˆ– null */
function detectGestureMostStable(lm){
  // lm: 21 landmarks normalized
  // ç”¨å½’ä¸€åŒ–è·ç¦»ä¸ä¼¸ç›´/å¼¯æ›²åˆ¤æ–­
  // æŒ‡å°–ç´¢å¼•ï¼šthumb tip 4, index tip 8, middle tip 12, ring 16, pinky 20
  const thumbTip = lm[4], indexTip = lm[8], middleTip = lm[12], ringTip = lm[16], pinkyTip = lm[20];
  const indexPip = lm[6], middlePip = lm[10], ringPip = lm[14], pinkyPip = lm[18], indexMcp = lm[5];

  // åˆ¤æ–­ä¼¸ç›´çš„æ‰‹æŒ‡æ•°
  const idxExt = fingerExtended(lm,8,6);
  const midExt = fingerExtended(lm,12,10);
  const ringExt = fingerExtended(lm,16,14);
  const pinkyExt = fingerExtended(lm,20,18);
  // æ‹‡æŒ‡ç‰¹æ®Šï¼šåˆ¤æ–­ thumb tip ä¸ index mcp çš„ç›¸å¯¹ä½ç½®
  const thumbIndexDist = normalizedDist(thumbTip,indexMcp,lm);

  // è§„åˆ™ï¼šOpen hand = å¤šæ•°æ‰‹æŒ‡ä¼¸ç›´
  const extendedCount = [idxExt, midExt, ringExt, pinkyExt].filter(Boolean).length;

  // Fist: å¤§éƒ¨åˆ†æŒ‡å°–æ¯”å¯¹åº” pip æ›´ä½ï¼ˆy å¤§ï¼‰
  const isFist = (!idxExt && !midExt && !ringExt && !pinkyExt);

  if (isFist) return "Closed_Fist";
  if (extendedCount >= 4) return "Open_Palm";

  // Pointing right/left: index extended, å…¶ä»–å¼¯æ›²ï¼Œåˆ¤æ–­ index tip ç›¸å¯¹ wrist x
  if (idxExt && !midExt && !ringExt && !pinkyExt) {
    // index tip ä¸ index mcp x çš„æ¯”è¾ƒåˆ¤æ–­å·¦å³ ï¼ˆåæ ‡ç³»ï¼š0 å·¦, 1 å³ï¼‰
    const pointingRight = indexTip.x > lm[5].x; // å³æ‰‹æœå‘ç”»é¢å³ä¾§
    if (pointingRight) return "Pointing_Right";
    else return "Pointing_Left";
  }

  // Victory: index & middle extended, others not
  if (idxExt && midExt && !ringExt && !pinkyExt) return "Victory";

  // Thumb up/down: æ‹‡æŒ‡ä¸æ‰‹è…•æ–¹å‘æ¯”è¾ƒ (æ£€æŸ¥ thumbTip.y ä¸ wrist.y)
  if (thumbIndexDist > 0.25) { // æ‹‡æŒ‡ä¸æŒå¿ƒè·ç¦»å¾ˆå¤§ -> å¯èƒ½ä¼¸å‡ºæ‹‡æŒ‡
    // æ‹‡æŒ‡ç›¸è¾ƒäº wrist çš„çºµå‘ä½ç½®åˆ¤æ–­ up/down
    if (thumbTip.y < lm[0].y - 0.03) return "OK gesture"; // é«˜äºæ‰‹è…•
    if (thumbTip.y > lm[0].y + 0.03) return "Index Finger Down";
  }

  // OK / pinch: index ä¸ thumb æ¥è¿‘
  const idxThumbDist = normalizedDist(indexTip, thumbTip, lm);
  if (idxThumbDist < 0.12) return "Pinch_OK";

  // ILoveYou: thumb + index + pinky extended pattern (ç®€åŒ–)
  if ( (thumbIndexDist > 0.18) && idxExt && !midExt && !ringExt && pinkyExt ) return "ILoveYou";

  return null;
}

/* é˜²æŠ–ä¸è§¦å‘ï¼šåªæœ‰è¿ç»­ STABLE_FRAMES å¸§éƒ½æ£€æµ‹ä¸ºåŒä¸€æ‰‹åŠ¿æ‰è§¦å‘ï¼Œå¹¶æœ‰ cooldown */
async function processDetectedGesture(gesture){
  const now = Date.now();
  if(gesture && gesture === lastStableGesture){
    stableCount = Math.min(stableCount + 1, STABLE_FRAMES + 5);
  } else if (gesture && gesture !== lastStableGesture) {
    lastStableGesture = gesture;
    stableCount = 1;
  } else {
    // gesture === null
    lastStableGesture = null;
    stableCount = 0;
  }

  if (lastStableGesture && stableCount >= STABLE_FRAMES && (now - lastTriggerAt) > COOLDOWN_MS) {
    // è§¦å‘åŠ¨ä½œ
    lastTriggerAt = now;
    triggerActionForGesture(lastStableGesture);
  }
}

/* è§¦å‘æ‰‹åŠ¿å¯¹åº”çš„åŠ¨ä½œï¼ˆéŸ³é‡æˆ–åˆ‡æ­Œï¼‰*/
function triggerActionForGesture(name){
  gestureNameEl.innerText = name;
  switch(name){
    case "Open_Palm":
      if (player.paused) player.play();
      break;
    case "Closed_Fist":
      if (!player.paused) player.pause();
      break;
    case "Victory":
      nextTrack();
      break;
    case "Pointing_Right":
      nextTrack();
      break;
    case "Pointing_Left":
      prevTrack();
      break;
    case "OK gesture":
      setVolume(Math.min(1, player.volume + 0.08)); // ä¸€æ¬¡æ€§å¾®å¢
      break;
    case "Index Finger Down":
      setVolume(Math.max(0, player.volume - 0.08));
      break;
    case "Pinch_OK":
      // æš‚å®šçŸ­æŒ‰åˆ‡æ¢æ’­æ”¾/æš‚åœ
      if (player.paused) player.play(); else player.pause();
      break;
    case "ILoveYou":
      player.loop = !player.loop;
      break;
    default:
      break;
  }
  // æ›´æ–° UI éŸ³é‡æ¡ä¸ track å
  volFill.style.width = `${Math.round(player.volume*100)}%`;
  trackName.innerText = `Track: ${audioFiles[currentTrack]}`;
}

/* å¹³æ»‘è®¾ç½®éŸ³é‡ï¼ˆæ›´å¹³æ»‘ï¼‰*/
function setVolume(v){
  // çº¿æ€§æ’å€¼ä¸€æ­¥åˆ°ä½ï¼ŒUI é€šè¿‡ CSS transition å¹³æ»‘
  player.volume = Math.max(0, Math.min(1, v));
  volFill.style.width = `${Math.round(player.volume*100)}%`;
}

function nextTrack(){
  currentTrack = (currentTrack + 1) % audioFiles.length;
  player.src = audioFiles[currentTrack];
  player.play();
  trackName.innerText = `Track: ${audioFiles[currentTrack]}`;
}
function prevTrack(){
  currentTrack = (currentTrack - 1 + audioFiles.length) % audioFiles.length;
  player.src = audioFiles[currentTrack];
  player.play();
  trackName.innerText = `Track: ${audioFiles[currentTrack]}`;
}

/* ------------ onResults å›è°ƒï¼šæ¥è‡ª MediaPipe Hands ------------ */
function onResults(results){
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0){
    // å–ç¬¬ä¸€ä¸ªæ‰‹
    let landmarks = results.multiHandLandmarks[0];

    // å°† landmarks è§„èŒƒåŒ–ä¸ºå¯¹è±¡æ•°ç»„ {x,y,z}
    // apply EMA smoothing
    smoothLandmarks = ema(smoothLandmarks, landmarks, SMOOTH_ALPHA);
    const lm = smoothLandmarks;

    // ç»˜åˆ¶
    drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#1db954', lineWidth: 2});
    drawLandmarks(ctx, lm, {color: '#fffd82', lineWidth: 1});

    // è®¡ç®—ç¨³å®šæ‰‹åŠ¿å¹¶å¤„ç†é˜²æŠ–/è§¦å‘
    const detected = detectGestureMostStable(lm);
    processDetectedGesture(detected);
  } else {
    // æ— æ‰‹æ—¶æ¸…ç©ºç¨³å®š
    lastStableGesture = null;
    stableCount = 0;
    gestureNameEl.innerText = "No hand";
  }
  ctx.restore();
}

/* å¯åŠ¨æ‘„åƒå¤´ï¼ˆMediaPipe Camera util å·²ç»å°è£…ï¼‰ - camera.start() å·²åœ¨ä¸Šé¢è°ƒç”¨ */

/* åˆå§‹åŒ–éŸ³é‡æ¡æ˜¾ç¤º */
volFill.style.width = `${Math.round(player.volume*100)}%`;

</script>

<head>
  <meta charset="UTF-8">
  <title>åº•éƒ¨å±…ä¸­åå­—</title>
  <style>
    .footer-name {
      position: fixed;      /* å›ºå®šåœ¨å±å¹•åº•éƒ¨ */
      bottom: 10px;         /* è·ç¦»åº•éƒ¨ 10px */
      left: 50%;            /* æ°´å¹³å±…ä¸­ */
      transform: translateX(-50%);
      font-size: 20px;
      color: #333;
    }
  </style>
</head>
<body>

  <!-- åº•éƒ¨åå­— -->
  <div class="footer-name">
    é»„æ¶›ï¼Œ 2025-09-17
  </div>

</body>
</html>
